<HTML>
<HEAD>
<TITLE>IPv4 Network Calculation Generator</TITLE>


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
<meta http-equiv="Content-type" content="text/html; charset=utf-8">

<link rel="stylesheet" type="text/css" href="jquery.mobile-1.4.5.min.css" />
<STYLE type="text/css">
<!--

body,input,button,.ui-btn,table {
	font-size: large;
	font-family: 'Courier New', monospace;
}

.ui-input-text input {
	text-align: right;
}

.ui-field-contain>label {
	min-width:11em;
}

.ui-field-contain .ui-controlgroup-label,.ui-field-contain .ui-controlgroup-controls {
	width:auto;
}

.ui-content {
	padding-top:0;
	padding-bottom:0;
}

.fieldIP {
	margin:0;
	padding:0px;
}

.fieldIP .ui-controlgroup-label {
	margin:0;
}

.fieldIP .ui-controlgroup-controls {
	float:right;
	min-width:15em;
}

//-->
</STYLE>


<script type="text/javascript" src="cordova.js"></script>
<SCRIPT type="text/javascript" charset="utf-8" src="jquery-1.11.2.min.js"></SCRIPT>
<script type="text/javascript" charset="utf-8" src="jquery.mobile-1.4.5.min.js"></script>
<SCRIPT language="javascript">
<!--

var ip_addr = new Array(4);
var nw_addr = new Array(4);
var prefix;
var valid = true;

jQuery(function ($) {
	$("#gen").click(function(){
		initialize();
		generate();
		$("#ver").button("enable").button("refresh");
		if ( $("#step_mode").prop("checked") ) {
			$("#gen").button("disable").button("refresh");
		}
	});
	$("#ver").click(function(){
		verify();
		validate_gen();
	});
	$("input[name=nw]").each(function (i) {
		$(this).click(function(){
			if ( $("#help_mode").prop("checked") ) {
				switch_cell($(this).attr("id").slice(-1));
			}
		});
	});
	$("input[name=class]").click(function(){
		validate_gen();
	});
	$("#step_mode").change(function(){
		validate_gen();
	});
});


function validate_gen() {
	if ( $("input[name=class]:checked").length > 0 && ( valid || !$("#step_mode").prop("checked") ) ) {
		$("#gen").button("enable").button("refresh");
	} else {
		$("#gen").button("disable").button("refresh");
	}
}


function initialize() {
	var ip_bits, ip_host, sb_mask;
	var min, max;
	var i;

	switch ( $("input[name=class]:checked").eq( 
		Math.floor( Math.random() * $("input[name=class]:checked").length ) 
	).val() ) {
	case 'A':
		ip_bits = '00001010';  // 10
		min = 8;
		break;
	case 'B':
		ip_bits = '10101100';  // 172
		min = 12;
		break;
	case 'C':
		ip_bits = '11000000';  // 192
		min = 16;
		break;
	}
	max = 30;

	do {
		prefix = random_range(min, max);
	} while ( $("#hard_mode").prop("checked") == true 
		&& (prefix == 24 || prefix == 16 || prefix == 8) );

	ip_bits += random_bits(8, prefix);
	do {
		ip_host = random_bits(prefix, 32);
	} while ( ip_host.match(/^(0+|1+)$/) );  // The host part is not allowed to be "all 0s" nor "all 1s".
	ip_bits += ip_host;

	sb_mask = Array(prefix+1).join("1") + Array(33-prefix).join("0");

	for ( i = 0; i < 4; i++ ) {
		ip_addr[i] = parseInt( ip_bits.slice(i*8, (i+1)*8), 2 );
		nw_addr[i] = parseInt( sb_mask.slice(i*8, (i+1)*8), 2 ) & ip_addr[i];
	}

	valid = false;
}


function random_range(min, max) {
	return Math.floor( Math.random() * (max-min+1) + min );
}

function random_bits(min, max) {
	var str = '';
	var i;

	for ( i = min; i < max; i++ ) {
		str += Math.floor( Math.random() * 2 );
	}
	return str;
}


function generate() {
	$("input[name=nw]").val("");
	$("span[name=rs]").html("");
	$("#nwBottom").height(0);

	$("input[name=ip]").each(function (i) {
		$(this).val(ip_addr[i]);
	});
	if (prefix < 10) {
		$("#pre").html(prefix+'&#160;');
	} else {
		$("#pre").html(prefix);
	}
}


function switch_cell(octet) {
	$("input[name=nw]:lt("+octet+")").each(function (i) {
		$(this).val(ip_addr[i]);
	});
	$("input[name=nw]:eq("+octet+")").val("");
	$("input[name=nw]:gt("+octet+")").val(0x00);
}


function verify() {
	var count = 0;

	$("input[name=nw]").each(function (i) {
		if ( nw_addr[i].toString() == $(this).val() ) {
			$("#rs"+i).html("&#10004;").css("color","green");
		} else {
			$("#rs"+i).html("&#10005;").css("color","red");
			count++;
		}
	});
	valid = count == 0;

	$("#nwBottom").height(8);
}

//-->
</SCRIPT>
</HEAD>


<BODY>
<div id="home" data-role="page">
	<div data-role="header" data-theme="b"> 
		<h1>IPv4 Calc</h1>
	</div> 
	<div role="main" class="ui-content">
		<FORM>
		      <input type="button" id="gen" value="Generate" class="ui-btn">
		<div class="ui-field-contain fieldIP"> 
		<fieldset data-role="controlgroup">
			<legend>Host IP Address:</legend>
			<TABLE cellspacing="0" cellpadding="0" align="right">
			  <TR>
			    <TD><input type="tel" id="ip0" name="ip" value="" size="3" readonly></TD>
			    <TD>.</TD>
			    <TD><input type="tel" id="ip1" name="ip" value="" size="3" readonly></TD>
			    <TD>.</TD>
			    <TD><input type="tel" id="ip2" name="ip" value="" size="3" readonly></TD>
			    <TD>.</TD>
			    <TD><input type="tel" id="ip3" name="ip" value="" size="3" readonly></TD>
			    <TD>/<SPAN id="pre">&#160;&#160;</SPAN></TD>
			  </TR>
			</TABLE>
		</fieldset>
		</div> 
		<div style="height:8px;"></div> 
		<div class="ui-field-contain fieldIP"> 
		<fieldset data-role="controlgroup">
			<legend>Network Address:</legend>
			<TABLE cellspacing="0" cellpadding="0" align="right">
			  <TR>
			    <TD><input type="tel" id="nw0" name="nw" value="" size="3"></TD>
			    <TD>.</TD>
			    <TD><input type="tel" id="nw1" name="nw" value="" size="3"></TD>
			    <TD>.</TD>
			    <TD><input type="tel" id="nw2" name="nw" value="" size="3"></TD>
			    <TD>.</TD>
			    <TD><input type="tel" id="nw3" name="nw" value="" size="3"></TD>
			    <TD>&#160;&#160;&#160;</TD>
			  </TR>
			  <TR align="center">
			    <TD><SPAN id="rs0" name="rs"></SPAN></TD>
			    <TD></TD>
			    <TD><SPAN id="rs1" name="rs"></SPAN></TD>
			    <TD></TD>
			    <TD><SPAN id="rs2" name="rs"></SPAN></TD>
			    <TD></TD>
			    <TD><SPAN id="rs3" name="rs"></SPAN></TD>
			    <TD></TD>
			  </TR>
			  <TR id="nwBottom" rowspan="8"></TR>
			</TABLE>
		</fieldset>
		</div> 
		      <input type="button" id="ver" value="Verify" disabled>
	</FORM></div>
	<div data-role="footer" data-position="fixed" data-theme="b" class="ui-bar"> 
		<a href="#cfg" class="ui-btn ui-corner-all">Config</a>
	</div> 
</div>

<div id="cfg" data-role="page">
	<div data-role="header" data-theme="b">
		<a href="#" class="ui-btn ui-corner-all ui-btn-left" onclick="window.history.back();">Back</a>
		<h1>Config</h1> 
	</div> 
	<div role="main" class="ui-content">
		<FORM>
		<div class="ui-field-contain"> 
		<fieldset data-role="controlgroup" data-type="horizontal">
			<legend>Class:</legend>
			<INPUT type="checkbox" id="classA" name="class" value="A" checked><label for="classA">A</label>
			<INPUT type="checkbox" id="classB" name="class" value="B" checked><label for="classB">B</label>
			<INPUT type="checkbox" id="classC" name="class" value="C" checked><label for="classC">C</label>
		</fieldset>
		</div>
		<div class="ui-field-contain"> 
			<label for="hard_mode">Exclude prefix 8, 16, 24:</label>
			<INPUT type="checkbox" id="hard_mode" value="1" data-role="flipswitch" checked>
		</div>
		<div class="ui-field-contain"> 
			<label for="help_mode">Auto fill inactive cells:</label>
			<INPUT type="checkbox" id="help_mode" value="1" data-role="flipswitch" checked>
		</div>
		<div class="ui-field-contain"> 
			<label for="hard_mode">Allow Generate only when solved:</label>
			<INPUT type="checkbox" id="step_mode" value="1" data-role="flipswitch" checked>
		</div>
		</FORM>
	</div>
</div>

</BODY>
</HTML>
